<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AWS Security Group Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Bootstrap 5 CSS CDN -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: #f5f7fa;
      padding: 20px 0;
    }
    .container {
      max-width: 1200px;
    }
    h1, h2, h3 {
      color: #333;
      margin-bottom: 1rem;
    }
    .card {
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      border-radius: 8px;
      background-color: #fff;
      padding: 1.5rem;
      margin-bottom: 2rem;
    }
    table th, table td {
      vertical-align: middle;
      font-size: 0.95rem;
    }
    .rule {
      margin-bottom: 0.3rem;
      font-size: 0.9rem;
    }
    .remaining-text {
      color: #6c757d; /* Bootstrap gray-600 */
      font-style: italic;
      margin-left: 6px;
    }
    .error {
      color: #dc3545;
    }
    .success {
      color: #198754;
    }
  </style>

  <script>
    function toggleExpirationField() {
      const action = document.getElementById("action").value;
      const expirationInput = document.getElementById("expiration_hour");

      if (action === "remove") {
        expirationInput.disabled = true;
        expirationInput.required = false;
      } else {
        expirationInput.disabled = false;
        expirationInput.required = true;
      }
    }

    window.onload = function () {
      toggleExpirationField();
      document.getElementById("action").addEventListener("change", toggleExpirationField);

      {% if error %}
        alert("Error: {{ error|escapejs }}");
      {% elif message %}
        alert("Success: {{ message|escapejs }}");
      {% elif rule_error %}
        alert("Error: {{ rule_error|escapejs }}");
      {% endif %}
    }
  </script>
</head>
<body>
<div class="container">
  <h1 class="mb-4">AWS Security Group Dashboard</h1>

  {% if error %}
    <div class="alert alert-danger" role="alert">
      Error: {{ error }}
    </div>
  {% elif security_groups %}
    {% for sg in security_groups %}
      <div class="card">
        <h2>{{ sg.GroupName }} <small class="text-muted">({{ sg.GroupId }})</small></h2>
        <p><strong>Description:</strong> {{ sg.Description }}</p>
        <p><strong>VPC ID:</strong> {{ sg.VpcId }}</p>

        <h3>Inbound Rules</h3>
        <div class="table-responsive">
          <table class="table table-striped table-bordered align-middle">
            <thead class="table-light">
              <tr>
                <th>Protocol</th>
                <th>Port Range</th>
                <th>Source</th>
              </tr>
            </thead>
            <tbody>
            {% for rule in sg.InboundRules %}
              <tr>
                <td>{{ rule.IpProtocol }}</td>
                <td>{% if rule.FromPort != None %}{{ rule.FromPort }} - {{ rule.ToPort }}{% else %}All{% endif %}</td>
                <td>
                  {% for ip in rule.IpRanges %}
                    <div class="rule">
                      {{ ip.CidrIp }}
                      {% if ip.remaining %}
                        <span class="remaining-text">({{ ip.remaining }})</span>
                      {% endif %}
                    </div>
                  {% empty %}
                    <div class="rule">-</div>
                  {% endfor %}
                </td>
              </tr>
            {% endfor %}
            </tbody>
          </table>
        </div>

        <h3>Outbound Rules</h3>
        <div class="table-responsive">
          <table class="table table-striped table-bordered align-middle">
            <thead class="table-light">
              <tr>
                <th>Protocol</th>
                <th>Port Range</th>
                <th>Destination</th>
              </tr>
            </thead>
            <tbody>
            {% for rule in sg.OutboundRules %}
              <tr>
                <td>{{ rule.IpProtocol }}</td>
                <td>{% if rule.FromPort != None %}{{ rule.FromPort }} - {{ rule.ToPort }}{% else %}All{% endif %}</td>
                <td>
                  {% for ip in rule.IpRanges %}
                    <div class="rule">{{ ip.CidrIp }}</div>
                  {% empty %}
                    <div class="rule">-</div>
                  {% endfor %}
                </td>
              </tr>
            {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    {% endfor %}
  {% else %}
    <div class="alert alert-info" role="alert">
      No security groups found.
    </div>
  {% endif %}

  <hr>

  <div class="card">
    <h2>Manage Inbound Rule</h2>

    <form method="post" class="row g-3">
      {% csrf_token %}

      <div class="col-md-3">
        <label for="action" class="form-label">Action</label>
        <select name="action" id="action" class="form-select" onchange="toggleExpirationField()" required>
          <option value="add">Add Rule</option>
          <option value="remove">Remove Rule</option>
          <option value="extend">Extend Expiration</option>
        </select>
      </div>

      <div class="col-md-4">
        <label for="GroupId" class="form-label">Security Group</label>
        <select name="GroupId" id="GroupId" class="form-select" required>
          {% for sg in security_groups %}
            <option value="{{ sg.GroupId }}">{{ sg.GroupName }} ({{ sg.GroupId }})</option>
          {% endfor %}
        </select>
      </div>

      <div class="col-md-2">
        <label for="IpProtocol" class="form-label">Protocol</label>
        <select name="IpProtocol" id="IpProtocol" class="form-select" required>
          {% for protocol in protocols %}
            <option value="{{ protocol }}">{{ protocol }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="col-md-1">
        <label for="FromPort" class="form-label">From Port</label>
        <input type="number" name="FromPort" id="FromPort" class="form-control" required>
      </div>

      <div class="col-md-1">
        <label for="ToPort" class="form-label">To Port</label>
        <input type="number" name="ToPort" id="ToPort" class="form-control" required>
      </div>

      <div class="col-md-3">
        <label for="CidrIp" class="form-label">CIDR</label>
        <input type="text" name="CidrIp" id="CidrIp" class="form-control" placeholder="e.g. 0.0.0.0/0" required>
      </div>

      <div class="col-md-3">
        <label for="device" class="form-label">Target Device</label>
        <select name="device" id="device" class="form-select" required>
          {% for device in devices %}
            <option value="{{ device }}">{{ device }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="col-md-2">
        <label for="expiration_hour" class="form-label">Expiration After (Hours)</label>
        <input type="number" name="expiration_hour" id="expiration_hour" class="form-control" min="1" max="24" required>
      </div>

      <div class="col-md-12">
        <button type="submit" class="btn btn-primary mt-3">Submit</button>
      </div>
    </form>
  </div>
</div>

<!-- Bootstrap 5 JS Bundle with Popper -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>
